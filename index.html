<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>This Week's Picks</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0d0f14;
      --surface:   #161a24;
      --surface2:  #1e2333;
      --border:    #2a3045;
      --accent:    #4f8ef7;
      --green:     #22c55e;
      --red:       #ef4444;
      --yellow:    #f59e0b;
      --muted:     #6b7594;
      --text:      #e2e8f0;
      --text2:     #94a3b8;
      --radius:    10px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 14px;
      min-height: 100vh;
      padding-bottom: 60px;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: linear-gradient(135deg, #0f1520 0%, #161e30 100%);
      border-bottom: 1px solid var(--border);
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }

    .logo { display: flex; align-items: center; gap: 10px; }

    .logo-icon {
      width: 36px; height: 36px;
      background: linear-gradient(135deg, var(--accent), #7c3aed);
      border-radius: 8px;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
    }

    .logo h1 { font-size: 18px; font-weight: 700; letter-spacing: -0.3px; }
    .logo h1 span { color: var(--accent); }

    .header-meta { display: flex; align-items: center; gap: 16px; flex-wrap: wrap; }

    .date-badge {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 5px 12px;
      font-size: 12px;
      color: var(--text2);
      font-weight: 500;
    }

    #last-updated { font-size: 11px; color: var(--muted); }

    /* â”€â”€ Summary Bar â”€â”€ */
    .summary-bar {
      display: flex;
      gap: 12px;
      padding: 16px 24px;
      overflow-x: auto;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }

    .stat-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 18px;
      min-width: 110px;
      text-align: center;
      flex-shrink: 0;
      transition: border-color 0.15s, transform 0.1s;
    }

    /* Clickable stat cards */
    .stat-card[data-filter] {
      cursor: pointer;
    }

    .stat-card[data-filter]:hover {
      border-color: #4a5580;
      transform: translateY(-2px);
    }

    .stat-card[data-filter].active-filter {
      background: #111827;
    }

    .stat-card[data-filter="all"].active-filter        { border-color: var(--yellow); }
    .stat-card[data-filter="win"].active-filter        { border-color: var(--green); }
    .stat-card[data-filter="loss"].active-filter       { border-color: var(--red); }
    .stat-card[data-filter="pending"].active-filter    { border-color: var(--accent); }
    .stat-card[data-filter="today"].active-filter      { border-color: var(--text2); }

    .stat-card .label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .stat-card .value { font-size: 22px; font-weight: 700; line-height: 1; color: var(--text); }
    .stat-card .value.green  { color: var(--green); }
    .stat-card .value.red    { color: var(--red); }
    .stat-card .value.yellow { color: var(--yellow); }
    .stat-card .value.blue   { color: var(--accent); }

    /* â”€â”€ Active filter banner â”€â”€ */
    .filter-banner {
      display: none;
      align-items: center;
      justify-content: space-between;
      padding: 8px 24px;
      background: #0f1421;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
      color: var(--text2);
    }

    .filter-banner.visible { display: flex; }

    .filter-banner .clear-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text2);
      cursor: pointer;
      font-size: 11px;
      padding: 3px 10px;
      transition: all 0.15s;
    }

    .filter-banner .clear-btn:hover { border-color: var(--accent); color: var(--accent); }

    /* â”€â”€ Tabs â”€â”€ */
    .tabs {
      display: flex;
      gap: 4px;
      padding: 16px 24px 0;
      overflow-x: auto;
      border-bottom: 1px solid var(--border);
    }

    .tab {
      background: none;
      border: 1px solid transparent;
      border-bottom: none;
      border-radius: 8px 8px 0 0;
      color: var(--muted);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      padding: 8px 16px;
      transition: all 0.15s;
      white-space: nowrap;
      margin-bottom: -1px;
    }

    .tab:hover { color: var(--text); background: var(--surface2); }

    .tab.active {
      background: var(--bg);
      border-color: var(--border);
      border-bottom-color: var(--bg);
      color: var(--accent);
    }

    .tab .count {
      display: inline-flex; align-items: center; justify-content: center;
      background: var(--surface2);
      border-radius: 10px;
      font-size: 10px; height: 16px; min-width: 16px;
      padding: 0 4px; margin-left: 6px;
      color: var(--text2);
    }

    .tab.active .count { background: var(--accent); color: #fff; }

    /* â”€â”€ Main â”€â”€ */
    main { padding: 0 24px 24px; }
    .section { display: none; padding-top: 20px; }
    .section.active { display: block; }

    /* â”€â”€ Day Groups â”€â”€ */
    .day-group { margin-bottom: 32px; }

    .day-heading {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 14px;
    }

    .day-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--text2);
      text-transform: uppercase;
      letter-spacing: 0.7px;
      white-space: nowrap;
    }

    .day-label.today { color: var(--accent); }

    .day-record {
      font-size: 11px;
      color: var(--muted);
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 2px 8px;
      white-space: nowrap;
    }

    .day-heading hr {
      flex: 1;
      border: none;
      border-top: 1px solid var(--border);
    }

    /* â”€â”€ Cards â”€â”€ */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: border-color 0.15s;
    }

    .card:hover { border-color: #3a4060; }
    .card.win     { border-left: 3px solid var(--green); }
    .card.loss    { border-left: 3px solid var(--red); }
    .card.push    { border-left: 3px solid var(--muted); }
    .card.pending { border-left: 3px solid var(--accent); }

    .card-header {
      background: var(--surface2);
      padding: 9px 13px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .matchup { font-size: 13px; font-weight: 600; line-height: 1.3; }

    .sport-tag {
      font-size: 10px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px;
      padding: 2px 7px; border-radius: 4px; flex-shrink: 0;
    }

    .sport-tag.nba { background: #1a3a5c; color: #60a5fa; }
    .sport-tag.cbb { background: #1a3a2a; color: #4ade80; }

    .card-body { padding: 11px 13px; }

    .pick-row { display: flex; align-items: center; gap: 10px; margin-bottom: 9px; }

    .pick-badge { font-size: 15px; font-weight: 800; color: var(--text); }
    .pick-badge.over  { color: var(--green); }
    .pick-badge.under { color: #f97316; }

    .pick-detail { font-size: 12px; color: var(--text2); line-height: 1.4; }

    .meta-row { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 7px; }

    .chip {
      display: flex; align-items: center; gap: 4px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 2px 7px;
      font-size: 11px; color: var(--text2);
    }

    .chip.edge-chip  { color: #fbbf24; border-color: #3a3020; background: #1e1a0e; }
    .chip.conf-high  { color: var(--green); border-color: #1a3a20; background: #0e1e0e; }
    .chip.conf-med   { color: var(--yellow); border-color: #3a2e10; background: #1e1a0a; }
    .chip.conf-low   { color: var(--muted); }

    .card-footer {
      border-top: 1px solid var(--border);
      padding: 7px 13px;
      display: flex; align-items: center; justify-content: space-between;
    }

    .status-badge {
      font-size: 11px; font-weight: 700;
      text-transform: uppercase; letter-spacing: 0.5px;
      padding: 2px 7px; border-radius: 4px;
    }

    .status-badge.win     { background: #0e2a18; color: var(--green); }
    .status-badge.loss    { background: #2a0e0e; color: var(--red); }
    .status-badge.push    { background: #1e1e1e; color: var(--muted); }
    .status-badge.pending { background: #0e1a38; color: var(--accent); }

    .result-score { font-size: 11px; color: var(--muted); }

    /* â”€â”€ Empty / Loading â”€â”€ */
    .empty { text-align: center; padding: 60px 20px; color: var(--muted); }
    .empty .icon { font-size: 40px; margin-bottom: 12px; }
    .empty p { font-size: 14px; }

    #loading { text-align: center; padding: 60px; color: var(--muted); }

    .spinner {
      display: inline-block; width: 28px; height: 28px;
      border: 3px solid var(--border); border-top-color: var(--accent);
      border-radius: 50%; animation: spin 0.7s linear infinite;
      margin-bottom: 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 600px) {
      header, .summary-bar, .tabs, main { padding-left: 14px; padding-right: 14px; }
      .cards-grid { grid-template-columns: 1fr; }
      .filter-banner { padding-left: 14px; padding-right: 14px; }
    }
  </style>
</head>
<body>

<header>
  <div class="logo">
    <div class="logo-icon">ðŸŽ¯</div>
    <h1>This Week's <span>Picks</span></h1>
  </div>
  <div class="header-meta">
    <div class="date-badge" id="week-range">â€”</div>
    <div id="last-updated">Loading...</div>
  </div>
</header>

<div class="summary-bar">
  <div class="stat-card active-filter" data-filter="all">
    <div class="label">Week Picks</div>
    <div class="value yellow" id="stat-total">â€”</div>
  </div>
  <div class="stat-card" data-filter="win">
    <div class="label">Won</div>
    <div class="value green" id="stat-wins">â€”</div>
  </div>
  <div class="stat-card" data-filter="loss">
    <div class="label">Lost</div>
    <div class="value red" id="stat-losses">â€”</div>
  </div>
  <div class="stat-card" data-filter="pending">
    <div class="label">Pending</div>
    <div class="value blue" id="stat-pending">â€”</div>
  </div>
  <div class="stat-card">
    <div class="label">Win %</div>
    <div class="value green" id="stat-pct">â€”</div>
  </div>
  <div class="stat-card" data-filter="today">
    <div class="label">Today</div>
    <div class="value" id="stat-today">â€”</div>
  </div>
</div>

<!-- Filter active banner -->
<div class="filter-banner" id="filter-banner">
  <span id="filter-label">Showing all picks</span>
  <button class="clear-btn" id="clear-filter">âœ• Clear filter</button>
</div>

<div class="tabs">
  <button class="tab active" data-section="all">All <span class="count" id="count-all">0</span></button>
  <button class="tab" data-section="nba-spreads">NBA Spreads <span class="count" id="count-nba-spreads">0</span></button>
  <button class="tab" data-section="nba-totals">NBA Totals <span class="count" id="count-nba-totals">0</span></button>
  <button class="tab" data-section="cbb-spreads">CBB Spreads <span class="count" id="count-cbb-spreads">0</span></button>
  <button class="tab" data-section="cbb-totals">CBB Totals <span class="count" id="count-cbb-totals">0</span></button>
</div>

<main>
  <div id="loading">
    <div class="spinner"></div>
    <p>Loading this week's picks...</p>
  </div>

  <div class="section active" id="section-all"></div>
  <div class="section" id="section-nba-spreads"></div>
  <div class="section" id="section-nba-totals"></div>
  <div class="section" id="section-cbb-spreads"></div>
  <div class="section" id="section-cbb-totals"></div>
</main>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const GITHUB_USER = "iamsnowblinded-afk";
const GITHUB_REPO = "my-picks";
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const BASE = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/main/data`;

const SOURCES = [
  { url: `${BASE}/spreads_ledger.json`,     type: "nba-spreads", label: "NBA" },
  { url: `${BASE}/totals_ledger.json`,      type: "nba-totals",  label: "NBA" },
  { url: `${BASE}/cbb_spreads_ledger.json`, type: "cbb-spreads", label: "CBB" },
  { url: `${BASE}/cbb_totals_ledger.json`,  type: "cbb-totals",  label: "CBB" },
];

// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let allBetsCache  = {};   // keyed by type
let activeFilter  = "all"; // "all" | "win" | "loss" | "pending" | "today"
let activeSection = "all";

// â”€â”€ Date Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getWeekBounds() {
  const now = new Date();
  const day = now.getDay();
  const monday = new Date(now);
  monday.setDate(now.getDate() - ((day + 6) % 7));
  monday.setHours(0, 0, 0, 0);
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  sunday.setHours(23, 59, 59, 999);
  return { monday, sunday };
}

function toDateStr(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function todayStr() { return toDateStr(new Date()); }

function isThisWeek(ts) {
  if (!ts) return false;
  const { monday, sunday } = getWeekBounds();
  const d = new Date(ts);
  return d >= monday && d <= sunday;
}

function friendlyDay(dateStr) {
  const today = todayStr();
  const yesterday = toDateStr(new Date(Date.now() - 86400000));
  if (dateStr === today)     return { label: "Today",     isToday: true };
  if (dateStr === yesterday) return { label: "Yesterday", isToday: false };
  const d = new Date(dateStr + "T12:00:00");
  return {
    label: d.toLocaleDateString("en-US", { weekday: "long", month: "short", day: "numeric" }),
    isToday: false
  };
}

// â”€â”€ Filter Logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilter(bets) {
  if (activeFilter === "all")     return bets;
  if (activeFilter === "today")   return bets.filter(b => (b.timestamp||"").startsWith(todayStr()));
  if (activeFilter === "pending") return bets.filter(b => !["win","loss","push"].includes((b.status||"").toLowerCase()));
  return bets.filter(b => (b.status||"").toLowerCase() === activeFilter);
}

const FILTER_LABELS = {
  all:     "Showing all picks",
  win:     "Showing wins only",
  loss:    "Showing losses only",
  pending: "Showing pending picks",
  today:   "Showing today's picks only",
};

function updateFilterUI() {
  const banner = document.getElementById("filter-banner");
  document.getElementById("filter-label").textContent = FILTER_LABELS[activeFilter] || "";

  if (activeFilter === "all") {
    banner.classList.remove("visible");
  } else {
    banner.classList.add("visible");
  }

  // Highlight active stat card
  document.querySelectorAll(".stat-card[data-filter]").forEach(card => {
    card.classList.toggle("active-filter", card.dataset.filter === activeFilter);
  });
}

// â”€â”€ Fetch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchLedger(src) {
  try {
    const res = await fetch(src.url + "?t=" + Date.now());
    if (!res.ok) return [];
    const data = await res.json();
    return Object.values(data)
      .filter(b => isThisWeek(b.timestamp))
      .map(b => ({ ...b, _type: src.type, _label: src.label }));
  } catch (e) {
    console.warn("Could not load", src.url, e);
    return [];
  }
}

// â”€â”€ Card Builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildCard(bet) {
  const status = (bet.status || "pending").toLowerCase();
  let matchup = "", pickLine = "", resultText = "";

  if (bet._type === "nba-spreads" || bet._type === "cbb-spreads") {
    matchup = `${bet.away} <span style="color:var(--muted)">@</span> ${bet.home}`;
    const spread = bet.spread > 0 ? `+${bet.spread}` : bet.spread;
    pickLine = `<span class="pick-badge">${bet.pick_team}</span>
                <div class="pick-detail">Spread: <strong>${spread}</strong> &nbsp;Â·&nbsp; Proj margin: ${bet.projected_margin > 0 ? '+' : ''}${bet.projected_margin}</div>`;
    if (bet.final_home_score != null)
      resultText = `${bet.away} ${bet.final_away_score} â€“ ${bet.home} ${bet.final_home_score}`;
  } else {
    matchup = `${bet.away} <span style="color:var(--muted)">@</span> ${bet.home}`;
    const dir = (bet.target || "").toUpperCase();
    pickLine = `<span class="pick-badge ${dir.toLowerCase()}">${dir}</span>
                <div class="pick-detail">Total: <strong>${bet.line}</strong> &nbsp;Â·&nbsp; Proj: ${bet.projection}</div>`;
    if (bet.final_total != null) resultText = `Final total: ${bet.final_total}`;
  }

  const confClass = { HIGH: "conf-high", MEDIUM: "conf-med", LOW: "conf-low" }[bet.confidence] || "conf-low";
  const edge = parseFloat(bet.edge || 0).toFixed(1);

  return `
  <div class="card ${status}">
    <div class="card-header">
      <div class="matchup">${matchup}</div>
      <span class="sport-tag ${bet._label.toLowerCase()}">${bet._label}</span>
    </div>
    <div class="card-body">
      <div class="pick-row">${pickLine}</div>
      <div class="meta-row">
        <div class="chip edge-chip">âš¡ Edge: ${edge}</div>
        ${bet.confidence ? `<div class="chip ${confClass}">ðŸŽ¯ ${bet.confidence}</div>` : ""}
        ${bet.is_live ? `<div class="chip">ðŸ”´ Live</div>` : ""}
        ${bet.over_probability ? `<div class="chip">${(bet.over_probability * 100).toFixed(0)}% prob</div>` : ""}
      </div>
    </div>
    <div class="card-footer">
      <span class="status-badge ${status}">${status}</span>
      <span class="result-score">${resultText}</span>
    </div>
  </div>`;
}

// â”€â”€ Render with day grouping â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSection(container, bets) {
  const filtered = applyFilter(bets);

  if (filtered.length === 0) {
    const msg = activeFilter === "all"
      ? "No picks this week for this category."
      : `No ${activeFilter === "today" ? "today's" : activeFilter} picks for this category.`;
    container.innerHTML = `<div class="empty"><div class="icon">ðŸ“­</div><p>${msg}</p></div>`;
    return;
  }

  const groups = {};
  for (const bet of filtered) {
    const dateStr = (bet.timestamp || "").slice(0, 10);
    if (!groups[dateStr]) groups[dateStr] = [];
    groups[dateStr].push(bet);
  }

  const sortedDates = Object.keys(groups).sort((a, b) => b.localeCompare(a));
  const statusOrder = { pending: 0, win: 1, loss: 2, push: 3 };

  let html = "";
  for (const dateStr of sortedDates) {
    const dayBets = groups[dateStr].sort((a, b) => (statusOrder[a.status]??0) - (statusOrder[b.status]??0));
    const { label, isToday } = friendlyDay(dateStr);
    const wins    = dayBets.filter(b => b.status === "win").length;
    const losses  = dayBets.filter(b => b.status === "loss").length;
    const decided = wins + losses;
    const record  = decided > 0
      ? `${wins}-${losses} (${Math.round(wins/decided*100)}%)`
      : `${dayBets.length} pick${dayBets.length !== 1 ? 's' : ''}`;

    html += `
    <div class="day-group">
      <div class="day-heading">
        <span class="day-label ${isToday ? 'today' : ''}">${label}</span>
        <span class="day-record">${record}</span>
        <hr />
      </div>
      <div class="cards-grid">
        ${dayBets.map(buildCard).join("")}
      </div>
    </div>`;
  }

  container.innerHTML = html;
}

// â”€â”€ Update Win % based on active tab + filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateWinPct() {
  const typeMap = {
    "all":         getAllBets(),
    "nba-spreads": allBetsCache["nba-spreads"] || [],
    "nba-totals":  allBetsCache["nba-totals"]  || [],
    "cbb-spreads": allBetsCache["cbb-spreads"] || [],
    "cbb-totals":  allBetsCache["cbb-totals"]  || [],
  };

  const bets    = applyFilter(typeMap[activeSection] || getAllBets());
  const wins    = bets.filter(b => b.status === "win").length;
  const losses  = bets.filter(b => b.status === "loss").length;
  const decided = wins + losses;

  document.getElementById("stat-pct").textContent = decided ? `${Math.round(wins / decided * 100)}%` : "â€”";

  const sectionLabel = {
    "all":         "Week",
    "nba-spreads": "NBA Spreads",
    "nba-totals":  "NBA Totals",
    "cbb-spreads": "CBB Spreads",
    "cbb-totals":  "CBB Totals",
  }[activeSection] || "Week";

  const filterSuffix = activeFilter !== "all" ? ` Â· ${activeFilter}` : "";
  document.querySelector("#stat-pct").closest(".stat-card").querySelector(".label").textContent =
    `${sectionLabel}${filterSuffix} W%`;
}

// â”€â”€ Re-render all visible sections with current filter â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilterToAll() {
  updateFilterUI();
  const typeMap = {
    "all":         getAllBets(),
    "nba-spreads": allBetsCache["nba-spreads"] || [],
    "nba-totals":  allBetsCache["nba-totals"]  || [],
    "cbb-spreads": allBetsCache["cbb-spreads"] || [],
    "cbb-totals":  allBetsCache["cbb-totals"]  || [],
  };

  for (const [key, bets] of Object.entries(typeMap)) {
    const container = document.getElementById(`section-${key}`);
    if (container) renderSection(container, bets);
  }
  updateWinPct();
}

function getAllBets() {
  return Object.values(allBetsCache).flat();
}

// â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const now = new Date();
  const { monday, sunday } = getWeekBounds();
  const fmt = d => d.toLocaleDateString("en-US", { month: "short", day: "numeric" });
  document.getElementById("week-range").textContent   = `${fmt(monday)} â€“ ${fmt(sunday)}`;
  document.getElementById("last-updated").textContent = `Updated ${now.toLocaleTimeString()}`;

  const results = await Promise.all(SOURCES.map(fetchLedger));

  // Store by type
  allBetsCache = {};
  for (let i = 0; i < SOURCES.length; i++) {
    allBetsCache[SOURCES[i].type] = results[i];
  }

  document.getElementById("loading").style.display = "none";

  const allBets = getAllBets();
  const wins    = allBets.filter(b => b.status === "win").length;
  const losses  = allBets.filter(b => b.status === "loss").length;
  const pending = allBets.filter(b => !["win","loss","push"].includes((b.status||"").toLowerCase())).length;
  const decided = wins + losses;
  const todayBets = allBets.filter(b => (b.timestamp||"").startsWith(todayStr()));

  document.getElementById("stat-total").textContent   = allBets.length;
  document.getElementById("stat-wins").textContent    = wins;
  document.getElementById("stat-losses").textContent  = losses;
  document.getElementById("stat-pending").textContent = pending;
  document.getElementById("stat-pct").textContent     = decided ? `${Math.round(wins/decided*100)}%` : "â€”";
  document.getElementById("stat-today").textContent   = todayBets.length;

  // Update tab counts (unfiltered)
  const typeMap = {
    "all":         allBets,
    "nba-spreads": allBetsCache["nba-spreads"] || [],
    "nba-totals":  allBetsCache["nba-totals"]  || [],
    "cbb-spreads": allBetsCache["cbb-spreads"] || [],
    "cbb-totals":  allBetsCache["cbb-totals"]  || [],
  };

  for (const [key, bets] of Object.entries(typeMap)) {
    const count = document.getElementById(`count-${key}`);
    if (count) count.textContent = bets.length;
    const container = document.getElementById(`section-${key}`);
    if (container) renderSection(container, bets);
  }

  updateFilterUI();
  updateWinPct();
}

// â”€â”€ Stat card filter clicks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".stat-card[data-filter]").forEach(card => {
  card.addEventListener("click", () => {
    const f = card.dataset.filter;
    // Toggle off if already active
    activeFilter = (activeFilter === f) ? "all" : f;
    applyFilterToAll();
  });
});

document.getElementById("clear-filter").addEventListener("click", () => {
  activeFilter = "all";
  applyFilterToAll();
});

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
    tab.classList.add("active");
    activeSection = tab.dataset.section;
    document.getElementById(`section-${activeSection}`).classList.add("active");
    updateWinPct();
  });
});

init();
setInterval(init, 5 * 60 * 1000);
</script>
</body>
</html>